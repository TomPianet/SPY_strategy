<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY Strategy — Thesis Website</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #070a10, var(--bg)); color:var(--text);
    }
    a{color:var(--accent)}
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 56px}
    header{
      display:flex; gap:18px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      padding:22px; border:1px solid var(--border); border-radius:16px; background:rgba(17,24,39,.72);
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .subtitle{margin:6px 0 0; color:var(--muted); font-size:14px; line-height:1.35}
    .pill{display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px}
    @media(min-width:900px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{
      padding:18px; border:1px solid var(--border); border-radius:16px; background:rgba(17,24,39,.72);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .small{color:var(--muted); font-size:12px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:13px}
    th{color:var(--muted); font-weight:600}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .mono{font-variant-numeric: tabular-nums}
    .ok{color:#a7f3d0}
    .warn{color:#fde68a}
    .bad{color:#fca5a5}
    .imgrow{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:900px){ .imgrow{grid-template-columns:1fr 1fr} }
    .img{
      width:100%; border-radius:14px; border:1px solid var(--border); background:#0a0e15;
    }
    .footer{margin-top:18px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>SPY Timing + Allocation Strategy (Thesis Demo)</h1>
        <p class="subtitle">
          Goal: compare a rules-based strategy against Buy & Hold SPY, and leveraged Buy & Hold variants (1.3x and 2.0x), net of costs and financing.
        </p>
        <div class="row" style="margin-top:10px">
          <span class="pill" id="lastUpdated">Loading…</span>
          <span class="pill" id="lastBacktest">—</span>
          <span class="pill" id="sampleUsed">—</span>
        </div>
      </div>
      <div style="max-width:420px">
        <div class="card" style="padding:14px">
          <div style="font-weight:600; margin-bottom:6px">Disclaimer</div>
          <div class="small">
            This website is for academic research and educational purposes only and does not constitute investment advice.
            Past performance does not guarantee future results.
          </div>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Strategy (simple explanation)</h2>
        <div class="small">
          Each week, the model outputs target portfolio weights across SPY (equities), TLT (bonds), GLD (gold), and BIL (cash).
          The position can be slightly leveraged when BIL becomes negative (borrowing).
          All results shown are computed from your backtest pipeline.
        </div>
      </section>

      <aside class="card">
        <h2>Next week allocation</h2>
        <div class="small" id="recoAsOf">Loading…</div>
        <div style="margin-top:10px">
          <table>
            <thead>
              <tr><th>Asset</th><th class="right">Weight</th></tr>
            </thead>
            <tbody id="weightsBody"></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px" id="recoFlags"></div>
      </aside>
    </div>

    <section class="card">
      <h2>Performance summary</h2>
      <div class="small" style="margin-bottom:10px">
        Metrics are read from <span class="mono">docs/data/latest.json</span> (generated by your Phase 7 export).
      </div>
      <table>
        <thead>
          <tr>
            <th>Series</th>
            <th class="right">YTD</th>
            <th class="right">CAGR</th>
            <th class="right">Vol</th>
            <th class="right">Sharpe</th>
            <th class="right">Sortino</th>
            <th class="right">MaxDD</th>
            <th class="right">Calmar</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Equity curve</h2>
      <div class="small" style="margin-bottom:10px">
        Loaded from <span class="mono">docs/data/equity_curve_TURBO_phase7_BASE.csv</span>.
      </div>
      <canvas id="eqChart" height="90"></canvas>
      <div class="footer">
        Tip: if the chart looks empty right after you publish, refresh after a minute — GitHub Pages sometimes needs a short cache warm-up.
      </div>
    </section>

    <section class="card">
      <h2>Figures (from your exported PNGs)</h2>
      <div class="imgrow">
        <img class="img" src="data/equity_curve_ALL_TURBO_phase7_BASE.png" alt="Equity curve all" onerror="this.style.display='none'">
        <img class="img" src="data/drawdown_TURBO_phase7_BASE.png" alt="Drawdown" onerror="this.style.display='none'">
      </div>
      <div class="small" style="margin-top:10px">
        If an image doesn’t show, it just means you didn’t upload that PNG — the page hides missing files automatically.
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const fmtPct = (x) => {
      if (x === null || x === undefined || Number.isNaN(x)) return "—";
      return (x * 100).toFixed(2) + "%";
    };
    const fmtNum = (x) => {
      if (x === null || x === undefined || Number.isNaN(x)) return "—";
      return Number(x).toFixed(2);
    };
    const esc = (s) => String(s).replaceAll("_"," ");

    async function loadJSON(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      return await r.json();
    }

    async function loadCSV(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      const text = await r.text();
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(",");
      const rows = lines.slice(1).map(line => {
        const parts = line.split(",");
        const obj = {};
        headers.forEach((h,i)=> obj[h] = parts[i]);
        return obj;
      });
      return {headers, rows};
    }

    function renderSummary(summary){
      const tbody = document.getElementById("summaryBody");
      tbody.innerHTML = "";

      const order = ["Strategy_Net","BuyHold_SPY","BuyHold_SPY_1.3x_Net","BuyHold_SPY_2.0x_Net"];
      order.forEach(name => {
        if(!summary[name]) return;
        const s = summary[name];

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${esc(name)}</td>
          <td class="right mono">${fmtPct(s.YTD)}</td>
          <td class="right mono">${fmtPct(s.CAGR)}</td>
          <td class="right mono">${fmtPct(s.Vol)}</td>
          <td class="right mono">${fmtNum(s.Sharpe)}</td>
          <td class="right mono">${fmtNum(s.Sortino)}</td>
          <td class="right mono">${fmtPct(s.MaxDD)}</td>
          <td class="right mono">${fmtNum(s.Calmar)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderReco(reco){
      document.getElementById("recoAsOf").textContent = "As of: " + reco.as_of;

      const wb = document.getElementById("weightsBody");
      wb.innerHTML = "";
      const w = reco.weights;

      const assets = ["SPY","TLT","GLD","BIL"];
      assets.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${a}</td>
          <td class="right mono">${(w[a]*100).toFixed(2)}%</td>
        `;
        wb.appendChild(tr);
      });

      const lev = reco.leverage ? "Leverage ON" : "Leverage OFF";
      const cls = reco.leverage ? "warn" : "ok";
      document.getElementById("recoFlags").innerHTML =
        `<span class="${cls}"><b>${lev}</b></span>
         <span class="small"> • risky gross: <span class="mono">${reco.risky_gross.toFixed(4)}x</span></span><br>
         <span class="small">${reco.note || ""}</span>`;
    }

    function renderChart(csv){
      // expects columns: date + *_Eq columns (your export format)
      const labels = csv.rows.map(r => r.date);

      const series = [
        {key:"Strategy_Net_Eq", label:"Strategy (Net)"},
        {key:"BuyHold_SPY_Eq", label:"Buy & Hold SPY"},
        {key:"BuyHold_SPY_1.3x_Net_Eq", label:"B&H SPY 1.3x (Net)"},
        {key:"BuyHold_SPY_2.0x_Net_Eq", label:"B&H SPY 2.0x (Net)"},
      ].filter(s => csv.headers.includes(s.key));

      const datasets = series.map(s => ({
        label: s.label,
        data: csv.rows.map(r => Number(r[s.key])),
        tension: 0.12,
        pointRadius: 0,
        borderWidth: 2
      }));

      const ctx = document.getElementById("eqChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: {mode:"index", intersect:false},
          plugins: {
            legend: {labels:{color:"#e5e7eb"}},
            tooltip: {callbacks:{
              label: (item) => `${item.dataset.label}: ${item.raw.toFixed(2)}`
            }}
          },
          scales: {
            x: {ticks:{color:"#94a3b8", maxTicksLimit: 8}, grid:{color:"rgba(148,163,184,.12)"}},
            y: {ticks:{color:"#94a3b8"}, grid:{color:"rgba(148,163,184,.12)"}}
          }
        }
      });
    }

    async function main(){
      // 1) load latest.json
      const latest = await loadJSON("data/latest.json");

      document.getElementById("lastUpdated").textContent =
        "Updated: " + (latest.updated_at ? latest.updated_at.replace("T"," ").replace("Z"," UTC") : "—");

      document.getElementById("lastBacktest").textContent =
        "Last backtest date: " + (latest.last_backtest_date || "—");

      document.getElementById("sampleUsed").textContent =
        "Metrics sample: " + (latest.sample_used_for_metrics || "—");

      renderSummary(latest.summary || {});
      renderReco(latest.recommendation || {as_of:"—", weights:{SPY:0,TLT:0,GLD:0,BIL:1}, risky_gross:1, leverage:false});

      // 2) load equity curve CSV and render chart
      const csv = await loadCSV("data/equity_curve_TURBO_phase7_BASE.csv");
      renderChart(csv);
    }

    main().catch(err => {
      console.error(err);
      document.getElementById("lastUpdated").textContent = "Error loading data. Check file names in docs/data.";
    });
  </script>
</body>
</html>
