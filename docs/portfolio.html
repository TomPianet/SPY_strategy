<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY Strategy — Live Portfolio</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">
        <div class="logo"><img src="assets/images/logo.png" alt="SPY Strategy Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;"></div>
        <div>
          <div class="brandTitle">Systematic Investment Platform</div>
          <div class="brandSub">Live Portfolio</div>
        </div>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a class="active" href="portfolio.html">Portfolio YTD</a>
        <a href="risk-management.html">Risk</a>
        <a href="results.html">Results</a>
        <a href="visuals.html">Visuals</a>
        <a href="methodology.html">Methodology</a>
      </div>
    </nav>

    <!-- Header Section -->
    <section style="margin-top: 24px; margin-bottom: 32px;">
        <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 12px; letter-spacing: -0.02em; font-family: 'Inter', sans-serif;">Live Portfolio Performance 8</h1>
      <p style="font-size: 16px; color: var(--muted); margin: 0 0 16px; line-height: 1.6;">Year-to-date performance breakdown and current allocation.</p>
      <span class="pill" id="portfolioDateRange" style="font-size: 11px;">As of: —</span>
    </section>

    <!-- Growth of $1,000 -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px; letter-spacing: -0.01em;">Growth of $1,000</h2>
      <div class="small" style="margin-bottom: 16px; font-size: 11px;">If you invested $1,000 on Jan 3, 2026 — here's where you'd be today.</div>
      <div id="growthTracker" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
        <!-- Will be populated by JavaScript -->
      </div>
    </section>

    <!-- YTD Chart -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px; letter-spacing: -0.01em;">YTD Cumulative Returns</h2>
      <div class="small" style="margin-bottom: 24px; font-size: 11px;">Strategy vs all benchmarks — net of costs & financing.</div>
      <div style="position: relative; height: 360px; width: 100%;">
        <canvas id="ytdChart"></canvas>
      </div>
    </section>

    <!-- YTD Summary + Allocation Grid -->
    <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px;">
      <!-- YTD Returns Summary -->
      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px; letter-spacing: -0.01em;">YTD Returns</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Cumulative year-to-date.</div>
        <div style="display: flex; flex-direction: column; gap: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">Strategy (Net)</span>
            <span class="stat-value stat-value-green" id="ytdStrategyMain" style="font-size: 15px; font-weight: 600;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY B&H</span>
            <span id="ytdSPYMain" style="font-size: 15px; font-weight: 600; color: var(--text);">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">50TLT/50GLD</span>
            <span id="ytdTLTGLD" style="font-size: 15px; font-weight: 600; color: var(--text);">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 1.3x (Net)</span>
            <span id="ytd13Main" style="font-size: 15px; font-weight: 600; color: var(--text);">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0;">
            <span style="font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 2.0x (Net)</span>
            <span id="ytd20Main" style="font-size: 15px; font-weight: 600; color: var(--text);">—</span>
          </div>
        </div>
      </section>

      <!-- Current Allocation -->
      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px; letter-spacing: -0.01em;">Current Allocation</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Next week weights.</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="font-size: 11px; padding: 8px 0;">Asset</th>
                <th class="right" style="font-size: 11px; padding: 8px 0;">Weight</th>
              </tr>
            </thead>
            <tbody id="allocationBody"></tbody>
          </table>
        </div>
        <div class="small" id="allocationFlags" style="margin-top: 16px; font-size: 11px;"></div>
      </section>
    </div>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    const fmtPct = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return (n * 100).toFixed(2) + "%";
    };
    const fmtNum = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return n.toFixed(2);
    };
    const fmtCurrency = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return "$" + n.toFixed(2);
    };

    async function loadJSON(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      return await r.json();
    }

    async function loadCSV(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      const text = await r.text();
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
      if(lines.length === 0) return {headers: [], rows: []};
      
      const headers = lines[0].split(",").map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const parts = line.split(",").map(p => p.trim());
        const obj = {};
        headers.forEach((h,i)=> {
          obj[h] = parts[i] || "";
        });
        return obj;
      });
      return {headers, rows};
    }

    function renderYTDChart(equityData, ytdStartDate){
      const canvas = document.getElementById("ytdChart");
      if(!canvas) {
        console.error("Canvas element not found");
        return;
      }

      // Check if Chart.js is loaded
      if(typeof Chart === 'undefined') {
        console.error("Chart.js not loaded");
        canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">Chart.js failed to load. Please refresh the page.</div>';
        return;
      }

      // Filter to YTD data only (2026)
      const ytdRows = equityData.rows.filter(r => {
        if(!r.date) return false;
        const dateStr = String(r.date);
        return dateStr.startsWith("2026");
      });

      if(ytdRows.length === 0) {
        console.warn("No 2026 data found for chart");
        canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">No YTD data available for 2026.</div>';
        return;
      }

      console.log(`Found ${ytdRows.length} YTD data points`);

      // Get starting values (first day of 2026) for each strategy separately
      const strategyStartValue = Number(ytdRows[0]?.Strategy_Net_Eq) || 1;
      const spyStartValue = Number(ytdRows[0]?.BuyHold_SPY_Eq) || 1;
      const spy13StartValue = Number(ytdRows[0]?.["BuyHold_SPY_1.3x_Net_Eq"]) || 1;
      const spy20StartValue = Number(ytdRows[0]?.["BuyHold_SPY_2.0x_Net_Eq"]) || 1;
      
      console.log("Strategy start:", strategyStartValue, "SPY start:", spyStartValue);
      
      // Calculate returns from start
      const labels = ytdRows.map(r => {
        const date = new Date(r.date);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      });

      const strategyData = ytdRows.map(r => {
        const value = Number(r.Strategy_Net_Eq) || strategyStartValue;
        return ((value / strategyStartValue) - 1) * 100; // Return as percentage
      });

      const spyData = ytdRows.map(r => {
        const value = Number(r.BuyHold_SPY_Eq) || spyStartValue;
        return ((value / spyStartValue) - 1) * 100;
      });

      const spy13Data = ytdRows.map(r => {
        const value = Number(r["BuyHold_SPY_1.3x_Net_Eq"]) || spy13StartValue;
        return ((value / spy13StartValue) - 1) * 100;
      });

      const spy20Data = ytdRows.map(r => {
        const value = Number(r["BuyHold_SPY_2.0x_Net_Eq"]) || spy20StartValue;
        return ((value / spy20StartValue) - 1) * 100;
      });
      
      console.log("First strategy return:", strategyData[0], "First SPY return:", spyData[0]);

      const ctx = canvas.getContext("2d");
      if(!ctx) {
        console.error("Could not get canvas context");
        canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">Could not initialize chart canvas.</div>';
        return;
      }

      if(typeof Chart === 'undefined') {
        console.error("Chart.js not loaded");
        canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--muted);">Chart.js library not loaded. Please refresh the page.</div>';
        return;
      }

      console.log("Creating chart with", ytdRows.length, "data points");
      
      try {
        new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Strategy (Net)",
              data: strategyData,
              borderColor: "hsl(142 72% 45%)",
              backgroundColor: "hsl(142 72% 45% / 0.08)",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 4,
              pointBackgroundColor: "hsl(142 72% 45%)",
              borderWidth: 2.5,
              fill: true,
            },
            {
              label: "SPY B&H",
              data: spyData,
              borderColor: "hsl(215 12% 50%)",
              backgroundColor: "hsl(215 12% 50% / 0.05)",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 4,
              pointBackgroundColor: "hsl(215 12% 50%)",
              borderWidth: 1.5,
              borderDash: [4, 2],
              fill: false,
            },
            {
              label: "SPY 1.3x",
              data: spy13Data,
              borderColor: "hsl(142 72% 55%)",
              backgroundColor: "transparent",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 4,
              pointBackgroundColor: "hsl(142 72% 55%)",
              borderWidth: 1.5,
              borderDash: [4, 2],
              fill: false,
            },
            {
              label: "SPY 2.0x",
              data: spy20Data,
              borderColor: "hsl(0 72% 55%)",
              backgroundColor: "transparent",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 4,
              pointBackgroundColor: "hsl(0 72% 55%)",
              borderWidth: 1.5,
              borderDash: [4, 2],
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {mode: "index", intersect: false},
          plugins: {
            legend: {
              labels: {
                color: "hsl(210 20% 92%)",
                font: {family: "'JetBrains Mono', monospace", size: 11},
                padding: 12,
                usePointStyle: true,
                pointStyle: 'line'
              },
              position: 'top',
              align: 'end'
            },
            tooltip: {
              backgroundColor: "hsl(220 18% 10% / 0.95)",
              borderColor: "hsl(220 14% 18%)",
              borderWidth: 1,
              padding: 10,
              titleColor: "hsl(210 20% 92%)",
              bodyColor: "hsl(210 20% 92%)",
              titleFont: {family: "'JetBrains Mono', monospace", size: 11},
              bodyFont: {family: "'JetBrains Mono', monospace", size: 11},
              callbacks: {
                label: (item) => {
                  const value = Number(item.raw);
                  const sign = value >= 0 ? "+" : "";
                  return `${item.dataset.label}: ${sign}${value.toFixed(2)}%`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "hsl(215 12% 50%)",
                maxTicksLimit: 10,
                font: {family: "'JetBrains Mono', monospace", size: 11}
              },
              grid: {
                color: "hsl(220 14% 18%)",
                drawBorder: false,
                lineWidth: 1
              },
              axisLine: {
                color: "hsl(220 14% 18%)"
              }
            },
            y: {
              ticks: {
                color: "hsl(215 12% 50%)",
                font: {family: "'JetBrains Mono', monospace", size: 11},
                callback: function(value) {
                  return value >= 0 ? "+" + value.toFixed(1) + "%" : value.toFixed(1) + "%";
                }
              },
              grid: {
                color: "hsl(220 14% 18%)",
                drawBorder: false,
                lineWidth: 1
              },
              axisLine: {
                color: "hsl(220 14% 18%)"
              },
              beginAtZero: false
            }
          }
        }
      });
      console.log("Chart created successfully");
      } catch(err) {
        console.error("Error creating chart:", err);
        canvas.parentElement.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--muted);">Error rendering chart: ${err.message}</div>`;
      }
    }

    function renderAllocation(reco){
      const w = reco.weights || {SPY:0,TLT:0,GLD:0,BIL:1};

      const body = document.getElementById("allocationBody");
      body.innerHTML = "";
      ["SPY","TLT","GLD","BIL"].forEach(a => {
        const weight = Number(w[a]);
        const tr = document.createElement("tr");
        const weightClass = weight < 0 ? "stat-value-red" : "stat-value-green";
        
        tr.innerHTML = `
          <td class="mono" style="font-weight: 500; font-size: 13px; padding: 10px 0;">${a}</td>
          <td class="right mono ${weightClass}" style="font-weight: 600; font-size: 13px; padding: 10px 0;">${(weight * 100).toFixed(2)}%</td>
        `;
        body.appendChild(tr);
      });

      const levOn = !!reco.leverage;
      const risky = (reco.risky_gross !== undefined) ? Number(reco.risky_gross).toFixed(4) : "—";

      document.getElementById("allocationFlags").innerHTML = `
        <span style="color: var(--trading-green); font-weight: 600;">${levOn ? "Leverage ON" : "Leverage OFF"}</span>
        <span class="muted"> · risky gross: <span class="mono">${risky}x</span></span>
      `;
    }

    function renderYTD(summary, extras){
      const s = summary || {};
      
      // YTD returns summary
      document.getElementById("ytdStrategyMain").textContent = fmtPct(s.Strategy_Net?.YTD);
      document.getElementById("ytdSPYMain").textContent = fmtPct(s.BuyHold_SPY?.YTD);
      
      // Get 50TLT/50GLD from metrics if available
      const tltGldYTD = extras?.series?.["Buy & Hold SPY"]?.ytd?.return || 0;
      document.getElementById("ytdTLTGLD").textContent = fmtPct(tltGldYTD);
      
      document.getElementById("ytd13Main").textContent = fmtPct(s["BuyHold_SPY_1.3x_Net"]?.YTD);
      document.getElementById("ytd20Main").textContent = fmtPct(s["BuyHold_SPY_2.0x_Net"]?.YTD);
    }

    function renderGrowthTracker(summary, extras){
      const s = summary || {};
      const container = document.getElementById("growthTracker");
      if(!container) return;

      const initialInvestment = 1000;
      
      const strategies = [
        { 
          label: "Strategy", 
          ytd: Number(s.Strategy_Net?.YTD) || 0,
          color: "var(--trading-green)"
        },
        { 
          label: "SPY B&H", 
          ytd: Number(s.BuyHold_SPY?.YTD) || 0,
          color: "var(--text)"
        },
        { 
          label: "SPY 1.3x", 
          ytd: Number(s["BuyHold_SPY_1.3x_Net"]?.YTD) || 0,
          color: "var(--text)"
        },
        { 
          label: "SPY 2.0x", 
          ytd: Number(s["BuyHold_SPY_2.0x_Net"]?.YTD) || 0,
          color: "var(--text)"
        }
      ];

      container.innerHTML = strategies.map(item => {
        const endValue = initialInvestment * (1 + item.ytd);
        const diff = endValue - initialInvestment;
        const isPositive = diff >= 0;
        const valueColor = item.label === "Strategy" ? "var(--trading-green)" : (isPositive ? "var(--text)" : "var(--trading-red)");
        const diffColor = isPositive ? "var(--trading-green)" : "var(--trading-red)";
        
        return `
          <div style="text-align: center;">
            <p style="font-size: 10px; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin: 0 0 8px;">${item.label}</p>
            <p style="font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: ${valueColor}; margin: 0 0 4px;">
              ${fmtCurrency(endValue)}
            </p>
            <p style="font-size: 11px; font-family: 'JetBrains Mono', monospace; color: ${diffColor}; margin: 0;">
              ${isPositive ? "+" : ""}${fmtCurrency(diff)}
            </p>
          </div>
        `;
      }).join("");
    }

    function renderMetrics(extras){
      const e = extras?.series?.["Strategy (Net)"] || {};
      
      // Win rate
      if(e.win_rate_daily !== undefined){
        document.getElementById("winRate").textContent = fmtPct(e.win_rate_daily);
      }
      
      // Best/Worst year
      if(e.best_worst_year?.best){
        const best = e.best_worst_year.best;
        document.getElementById("bestYear").textContent = `${best.year}: ${fmtPct(best.return)}`;
      }
      
      if(e.best_worst_year?.worst){
        const worst = e.best_worst_year.worst;
        document.getElementById("worstYear").textContent = `${worst.year}: ${fmtPct(worst.return)}`;
      }
      
      // Max drawdown
      if(e.max_drawdown?.maxdd !== undefined){
        document.getElementById("maxDD").textContent = fmtPct(e.max_drawdown.maxdd);
      }
    }

    async function main(){
      try {
        const latest = await loadJSON("data/latest.json");
        const extras = await loadJSON("data/extras.json");
        const equityCSV = await loadCSV("data/equity_curve_TURBO_phase7_BASE.csv");
        
        // Date range
        const ytd = extras?.series?.["Strategy (Net)"]?.ytd;
        if(ytd && ytd.end){
          const endDate = new Date(ytd.end).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'});
          document.getElementById("portfolioDateRange").textContent = `As of: ${endDate}`;
        }
        
        renderAllocation(latest.recommendation || {});
        renderYTD(latest.summary || {}, extras);
        renderGrowthTracker(latest.summary || {}, extras);
        
        // Wait for Chart.js to be available, then render chart
        const renderChart = () => {
          if(typeof Chart !== 'undefined') {
            renderYTDChart(equityCSV, ytd?.start);
          } else {
            console.log("Waiting for Chart.js...");
            setTimeout(renderChart, 100);
          }
        };
        
        // Start trying to render after a short delay to ensure Chart.js is loaded
        setTimeout(renderChart, 200);
      } catch(err) {
        console.error("Error in main:", err);
      }
    }

    main().catch(err => {
      console.error("Fatal error:", err);
    });
  </script>
</body>
</html>

