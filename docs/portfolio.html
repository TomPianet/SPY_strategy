<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY Strategy — Live Portfolio</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="brandTitle">SPY Timing + Allocation</div>
          <div class="brandSub">Live Portfolio</div>
        </div>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a href="results.html">Results</a>
        <a href="portfolio.html">Portfolio</a>
        <a href="visuals.html">Visuals</a>
        <a href="methodology.html">Methodology</a>
      </div>
    </nav>

    <!-- Header Section -->
    <section class="card" style="margin-top: 24px;">
      <div style="margin-bottom: 24px;">
        <h1 style="font-size: 28px; font-weight: 800; margin: 0 0 8px; letter-spacing: -0.02em;">Live Portfolio Performance</h1>
        <div class="small" style="font-size: 14px; color: var(--muted);">Year-to-date tracking since January 2026</div>
      </div>

      <div class="pills">
        <span class="pill" id="portfolioDateRange">Period: —</span>
        <span class="pill" id="portfolioUpdated">Last updated: —</span>
      </div>
    </section>

    <!-- Main YTD Performance Card -->
    <section class="card" style="margin-top: 20px; background: linear-gradient(135deg, hsl(220 18% 10% / 0.9), hsl(220 18% 12% / 0.9)); border: 1px solid hsl(142 72% 45% / 0.2);">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 40px; margin-bottom: 32px;">
        <div>
          <div class="small" style="margin-bottom: 16px; color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.12em; font-family: 'JetBrains Mono', monospace; font-weight: 600;">Strategy Net</div>
          <div class="stat-value stat-value-green" id="ytdStrategyMain" style="font-size: 4rem; font-weight: 900; line-height: 1.1; margin-bottom: 12px;">—</div>
          <div style="margin-top: 12px; color: var(--text); font-size: 18px; font-weight: 600; font-family: 'JetBrains Mono', monospace; line-height: 1.5;" id="ytdStrategyPnL">—</div>
        </div>
        <div>
          <div class="small" style="margin-bottom: 16px; color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.12em; font-family: 'JetBrains Mono', monospace; font-weight: 600;">SPY Buy & Hold</div>
          <div class="stat-value" id="ytdSPYMain" style="font-size: 3.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 12px; color: var(--text);">—</div>
          <div style="margin-top: 12px; color: var(--text); font-size: 18px; font-weight: 600; font-family: 'JetBrains Mono', monospace; line-height: 1.5;" id="ytdSPYPnL">—</div>
        </div>
        <div>
          <div class="small" style="margin-bottom: 16px; color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 0.12em; font-family: 'JetBrains Mono', monospace; font-weight: 600;">Outperformance</div>
          <div class="stat-value stat-value-green" id="ytdOutperformance" style="font-size: 3.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 12px;">—</div>
          <div class="small" style="margin-top: 12px; color: var(--muted); font-size: 14px;">vs SPY Buy & Hold</div>
        </div>
      </div>
    </section>

    <!-- Current Allocation -->
    <section class="card" style="margin-top: 20px;">
      <h2>Current Allocation</h2>
      <div class="small" id="allocationAsOf" style="margin-bottom: 16px;">As of: —</div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>Asset</th><th class="right">Weight</th><th class="right">Status</th></tr>
          </thead>
          <tbody id="allocationBody"></tbody>
        </table>
      </div>

      <div class="small" id="allocationFlags" style="margin-top:16px"></div>
    </section>

    <!-- Performance Comparison -->
    <section class="card" style="margin-top: 20px;">
      <h2>YTD Performance Comparison</h2>
      <div class="small" style="margin-bottom: 20px;">Year-to-date returns comparison across strategies.</div>

      <div class="kpis">
        <div class="kpi">
          <div class="kpiLabel">Strategy (Net)</div>
          <div class="kpiValue" id="ytdStrategy">—</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">SPY Buy & Hold</div>
          <div class="kpiValue" id="ytdSPY">—</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">SPY 1.3x (Net)</div>
          <div class="kpiValue" id="ytd13">—</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">SPY 2.0x (Net)</div>
          <div class="kpiValue" id="ytd20">—</div>
        </div>
      </div>
    </section>

    <!-- YTD Performance Chart -->
    <section class="card" style="margin-top: 20px;">
      <h2>YTD Performance Over Time</h2>
      <div class="small" style="margin-bottom: 16px;">Equity curve tracking since the start of 2026.</div>
      <div style="position: relative; height: 400px; width: 100%;">
        <canvas id="ytdChart"></canvas>
      </div>
    </section>

    <!-- Additional Metrics -->
    <section class="card" style="margin-top: 20px;">
      <h2>Portfolio Metrics</h2>
      <div class="small" style="margin-bottom: 20px;">Key performance indicators for the strategy.</div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; background: hsl(220 18% 8% / 0.5);">
          <div class="small" style="margin-bottom: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-family: 'JetBrains Mono', monospace;">Win Rate</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--trading-green);" id="winRate">—</div>
        </div>
        <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; background: hsl(220 18% 8% / 0.5);">
          <div class="small" style="margin-bottom: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-family: 'JetBrains Mono', monospace;">Best Year</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--trading-green);" id="bestYear">—</div>
        </div>
        <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; background: hsl(220 18% 8% / 0.5);">
          <div class="small" style="margin-bottom: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-family: 'JetBrains Mono', monospace;">Worst Year</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--trading-red);" id="worstYear">—</div>
        </div>
        <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; background: hsl(220 18% 8% / 0.5);">
          <div class="small" style="margin-bottom: 8px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-family: 'JetBrains Mono', monospace;">Max Drawdown</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--trading-red);" id="maxDD">—</div>
        </div>
      </div>
    </section>

    <div class="footer muted" style="margin-top: 40px; text-align: center;">
      Portfolio performance is tracked from the start of the current year. Data updates automatically when new backtest results are available.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    // Wait for Chart.js to be available
    if(typeof Chart === 'undefined') {
      await new Promise(resolve => {
        const checkChart = setInterval(() => {
          if(typeof Chart !== 'undefined') {
            clearInterval(checkChart);
            resolve();
          }
        }, 50);
        setTimeout(() => {
          clearInterval(checkChart);
          resolve();
        }, 5000);
      });
    }
    const fmtPct = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return (n * 100).toFixed(2) + "%";
    };
    const fmtNum = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return n.toFixed(2);
    };
    const fmtCurrency = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return "$" + n.toFixed(2);
    };

    async function loadJSON(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      return await r.json();
    }

    async function loadCSV(path){
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      const text = await r.text();
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
      if(lines.length === 0) return {headers: [], rows: []};
      
      const headers = lines[0].split(",").map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const parts = line.split(",").map(p => p.trim());
        const obj = {};
        headers.forEach((h,i)=> {
          obj[h] = parts[i] || "";
        });
        return obj;
      });
      return {headers, rows};
    }

    function renderYTDChart(equityData, ytdStartDate){
      const canvas = document.getElementById("ytdChart");
      if(!canvas) {
        console.error("Canvas element not found");
        return;
      }

      // Filter to YTD data only (2026)
      const ytdRows = equityData.rows.filter(r => {
        if(!r.date) return false;
        const dateStr = String(r.date);
        return dateStr.startsWith("2026");
      });

      if(ytdRows.length === 0) {
        console.warn("No 2026 data found for chart");
        return;
      }

      console.log(`Found ${ytdRows.length} YTD data points`);

      // Get starting value (first day of 2026)
      const startValue = Number(ytdRows[0]?.Strategy_Net_Eq) || 1;
      
      // Calculate returns from start
      const labels = ytdRows.map(r => {
        const date = new Date(r.date);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      });

      const strategyData = ytdRows.map(r => {
        const value = Number(r.Strategy_Net_Eq) || startValue;
        return ((value / startValue) - 1) * 100; // Return as percentage
      });

      const spyData = ytdRows.map(r => {
        const value = Number(r.BuyHold_SPY_Eq) || startValue;
        return ((value / startValue) - 1) * 100;
      });

      const ctx = canvas.getContext("2d");
      if(!ctx) {
        console.error("Could not get canvas context");
        return;
      }

      if(typeof Chart === 'undefined') {
        console.error("Chart.js not loaded");
        return;
      }

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Strategy (Net)",
              data: strategyData,
              borderColor: "hsl(142 72% 45%)",
              backgroundColor: "hsl(142 72% 45% / 0.1)",
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 3,
              fill: true,
            },
            {
              label: "SPY Buy & Hold",
              data: spyData,
              borderColor: "hsl(215 12% 50%)",
              backgroundColor: "hsl(215 12% 50% / 0.05)",
              tension: 0.4,
              pointRadius: 0,
              borderWidth: 2,
              borderDash: [5, 5],
              fill: true,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {mode: "index", intersect: false},
          plugins: {
            legend: {
              labels: {
                color: "hsl(210 20% 92%)",
                font: {family: "'Inter', sans-serif", size: 12},
                padding: 15,
              }
            },
            tooltip: {
              backgroundColor: "hsl(220 18% 10% / 0.95)",
              borderColor: "hsl(220 14% 18%)",
              borderWidth: 1,
              padding: 12,
              titleColor: "hsl(210 20% 92%)",
              bodyColor: "hsl(210 20% 92%)",
              callbacks: {
                label: (item) => {
                  const value = Number(item.raw);
                  const sign = value >= 0 ? "+" : "";
                  return `${item.dataset.label}: ${sign}${value.toFixed(2)}%`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "hsl(215 12% 50%)",
                maxTicksLimit: 12,
                font: {size: 11}
              },
              grid: {
                color: "hsl(220 14% 18%)",
                drawBorder: false
              }
            },
            y: {
              ticks: {
                color: "hsl(215 12% 50%)",
                font: {size: 11},
                callback: function(value) {
                  return value >= 0 ? "+" + value.toFixed(1) + "%" : value.toFixed(1) + "%";
                }
              },
              grid: {
                color: "hsl(220 14% 18%)",
                drawBorder: false
              },
              beginAtZero: false
            }
          }
        }
      });
    }

    function renderAllocation(reco){
      document.getElementById("allocationAsOf").textContent = "As of: " + (reco.as_of || "—");
      const w = reco.weights || {SPY:0,TLT:0,GLD:0,BIL:1};

      const body = document.getElementById("allocationBody");
      body.innerHTML = "";
      ["SPY","TLT","GLD","BIL"].forEach(a => {
        const weight = Number(w[a]);
        const tr = document.createElement("tr");
        const status = weight > 0 ? "Long" : weight < 0 ? "Short" : "Neutral";
        const statusClass = weight > 0 ? "good" : weight < 0 ? "warn" : "muted";
        
        tr.innerHTML = `
          <td class="mono" style="font-weight: 600;">${a}</td>
          <td class="right mono" style="font-weight: 600;">${(weight * 100).toFixed(2)}%</td>
          <td class="right"><span class="${statusClass}" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; text-transform: uppercase;">${status}</span></td>
        `;
        body.appendChild(tr);
      });

      const levOn = !!reco.leverage;
      const cls = levOn ? "tag warn" : "tag good";
      const risky = (reco.risky_gross !== undefined) ? Number(reco.risky_gross).toFixed(4) : "—";

      document.getElementById("allocationFlags").innerHTML = `
        <span class="${cls}">${levOn ? "Leverage ON" : "Leverage OFF"}</span>
        <span class="muted"> • risky gross: <span class="mono">${risky}x</span></span>
      `;
    }

    function renderYTD(summary, extras){
      const s = summary || {};
      const e = extras?.series?.["Strategy (Net)"] || {};
      const ytd = e.ytd || {};
      
      // Main YTD returns
      document.getElementById("ytdStrategyMain").textContent = fmtPct(s.Strategy_Net?.YTD);
      document.getElementById("ytdSPYMain").textContent = fmtPct(s.BuyHold_SPY?.YTD);
      
      // Calculate outperformance
      const strategyYTD = s.Strategy_Net?.YTD || 0;
      const spyYTD = s.BuyHold_SPY?.YTD || 0;
      const outperformance = strategyYTD - spyYTD;
      document.getElementById("ytdOutperformance").textContent = fmtPct(outperformance);
      
      // P&L if available
      if(ytd.start_value && ytd.end_value){
        const startVal = ytd.start_value;
        const endVal = ytd.end_value;
        const pnl = endVal - startVal;
        document.getElementById("ytdStrategyPnL").textContent = 
          `${fmtCurrency(startVal)} → ${fmtCurrency(endVal)} (${fmtCurrency(pnl)})`;
        
        // SPY P&L (approximate)
        const spyStart = startVal;
        const spyEnd = spyStart * (1 + (s.BuyHold_SPY?.YTD || 0));
        const spyPnl = spyEnd - spyStart;
        document.getElementById("ytdSPYPnL").textContent = 
          `${fmtCurrency(spyStart)} → ${fmtCurrency(spyEnd)} (${fmtCurrency(spyPnl)})`;
      }
      
      // KPI cards
      document.getElementById("ytdStrategy").textContent = fmtPct(s.Strategy_Net?.YTD);
      document.getElementById("ytdSPY").textContent = fmtPct(s.BuyHold_SPY?.YTD);
      document.getElementById("ytd13").textContent = fmtPct(s["BuyHold_SPY_1.3x_Net"]?.YTD);
      document.getElementById("ytd20").textContent = fmtPct(s["BuyHold_SPY_2.0x_Net"]?.YTD);
    }

    function renderMetrics(extras){
      const e = extras?.series?.["Strategy (Net)"] || {};
      
      // Win rate
      if(e.win_rate_daily !== undefined){
        document.getElementById("winRate").textContent = fmtPct(e.win_rate_daily);
      }
      
      // Best/Worst year
      if(e.best_worst_year?.best){
        const best = e.best_worst_year.best;
        document.getElementById("bestYear").textContent = `${best.year}: ${fmtPct(best.return)}`;
      }
      
      if(e.best_worst_year?.worst){
        const worst = e.best_worst_year.worst;
        document.getElementById("worstYear").textContent = `${worst.year}: ${fmtPct(worst.return)}`;
      }
      
      // Max drawdown
      if(e.max_drawdown?.maxdd !== undefined){
        document.getElementById("maxDD").textContent = fmtPct(e.max_drawdown.maxdd);
      }
    }

    async function main(){
      try {
        const latest = await loadJSON("data/latest.json");
        const extras = await loadJSON("data/extras.json");
        const equityCSV = await loadCSV("data/equity_curve_TURBO_phase7_BASE.csv");
        
        // Date range
        const ytd = extras?.series?.["Strategy (Net)"]?.ytd;
        if(ytd){
          const startDate = ytd.start ? new Date(ytd.start).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : "—";
          const endDate = ytd.end ? new Date(ytd.end).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : "—";
          document.getElementById("portfolioDateRange").textContent = `Period: ${startDate} → ${endDate}`;
        }
        
        // Last updated
        if(latest.updated_at){
          const updated = new Date(latest.updated_at).toLocaleString('en-US', {year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
          document.getElementById("portfolioUpdated").textContent = `Last updated: ${updated}`;
        }
        
        renderAllocation(latest.recommendation || {});
        renderYTD(latest.summary || {}, extras);
        renderMetrics(extras);
        
        // Render chart
        if(typeof Chart !== 'undefined') {
          renderYTDChart(equityCSV, ytd?.start);
        } else {
          console.error("Chart.js not loaded");
        }
      } catch(err) {
        console.error("Error in main:", err);
      }
    }

    main().catch(err => {
      console.error("Fatal error:", err);
    });
  </script>
</body>
</html>

