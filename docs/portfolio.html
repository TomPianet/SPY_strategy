<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY Strategy — Portfolio Live 4</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">
        <div class="logo"><img src="assets/images/logo.png" alt="SPY Strategy Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;"></div>
        <div>
          <div class="brandTitle">Systematic Investment Platform</div>
          <div class="brandSub">Live Portfolio</div>
        </div>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a class="active" href="portfolio.html">Portfolio YTD</a>
        <a href="risk-management.html">Risk</a>
        <a href="results.html">Results</a>
        <a href="visuals.html">Visuals</a>
        <a href="methodology.html">Methodology</a>
      </div>
    </nav>

    <!-- Header -->
    <section style="margin-top: 24px; margin-bottom: 32px;">
      <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 12px; letter-spacing: -0.02em; font-family: 'Inter', sans-serif;">Portfolio Live 4</h1>
      <p style="font-size: 16px; color: var(--muted); margin: 0 0 16px; line-height: 1.6;">Year-to-date performance, $1,000 growth comparison, and current allocation.</p>
      <span class="pill" id="portfolioDateRange" style="font-size: 11px;">As of: —</span>
    </section>

    <!-- 1. Growth of $1,000 (top) -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">Growth of $1,000</h2>
      <div class="small" style="margin-bottom: 16px; font-size: 11px;" id="growthTrackerDesc">If you invested $1,000 at the start of YTD — here's where you'd be today.</div>
      <div id="growthTracker" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
        <p style="font-size: 13px; color: var(--muted); margin: 0;">Loading…</p>
      </div>
    </section>

    <!-- 2. YTD Chart: strategy vs benchmarks -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">YTD cumulative returns</h2>
      <div class="small" style="margin-bottom: 24px; font-size: 11px;">Strategy vs benchmarks — net of costs &amp; financing.</div>
      <div style="position: relative; height: 360px; width: 100%;" id="ytdChartWrap">
        <canvas id="ytdChart"></canvas>
        <div id="ytdChartPlaceholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;">Loading chart…</div>
      </div>
    </section>

    <!-- 3. YTD numbers + Allocation (two columns) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px;">
      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">YTD returns (numbers)</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Cumulative year-to-date — from your data.</div>
        <div style="display: flex; flex-direction: column; gap: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">Strategy (Net)</span>
            <span class="stat-value stat-value-green mono" id="ytdStrategyMain" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY B&H</span>
            <span id="ytdSPYMain" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 1.3x (Net)</span>
            <span id="ytd13Main" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0;">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 2.0x (Net)</span>
            <span id="ytd20Main" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">Current allocation</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Actual portfolio weights (next week).</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="font-size: 11px; padding: 8px 0;">Asset</th>
                <th class="right" style="font-size: 11px; padding: 8px 0;">Weight</th>
              </tr>
            </thead>
            <tbody id="allocationBody"></tbody>
          </table>
        </div>
        <div class="small" id="allocationFlags" style="margin-top: 16px; font-size: 11px;"></div>
      </section>
    </div>
  </div>

  <script type="module">
    const fmtPct = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return (n * 100).toFixed(2) + "%";
    };

    const fmtCurrency = (x) => {
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return "$" + n.toFixed(2);
    };

    const el = (id) => document.getElementById(id);
    const setText = (id, val) => { const e = el(id); if (e) e.textContent = val; };

    async function loadJSON(path){
      const r = await fetch(path, {cache: "no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      return r.json();
    }

    async function loadCSV(path){
      const r = await fetch(path, {cache: "no-store"});
      if(!r.ok) throw new Error("Cannot load " + path);
      let text = await r.text();
      if(text.length && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
      if(lines.length === 0) return {headers: [], rows: []};
      const headers = lines[0].split(",").map(h => h.trim().replace(/^\uFEFF/, ""));
      const rows = lines.slice(1).map(line => {
        const parts = line.split(",").map(p => p.trim());
        const obj = {};
        headers.forEach((h, i) => { obj[h] = parts[i] || ""; });
        return obj;
      });
      return {headers, rows};
    }

    function computeYTDFromEquity(rows, ytdYear){
      const ytdRows = rows.filter(r => r.date && String(r.date).startsWith(String(ytdYear)));
      if(ytdRows.length < 1) return null;
      const first = ytdRows[0];
      const last = ytdRows[ytdRows.length - 1];
      const cols = ["Strategy_Net_Eq", "BuyHold_SPY_Eq", "BuyHold_SPY_1.3x_Net_Eq", "BuyHold_SPY_2.0x_Net_Eq"];
      const keys = ["Strategy_Net", "BuyHold_SPY", "BuyHold_SPY_1.3x_Net", "BuyHold_SPY_2.0x_Net"];
      const out = {};
      cols.forEach((col, i) => {
        const s = Number(first[col]) || 1;
        const e = Number(last[col]) || 1;
        out[keys[i]] = s > 0 ? (e / s) - 1 : 0;
      });
      return out;
    }

    function renderAllocation(reco){
      const body = el("allocationBody");
      if(!body) return;
      body.innerHTML = "";
      const w = (reco && reco.weights) || {SPY: 0, TLT: 0, GLD: 0, BIL: 1};
      ["SPY", "TLT", "GLD", "BIL"].forEach((a) => {
        const weight = Number(w[a]);
        const tr = document.createElement("tr");
        const cls = weight < 0 ? "stat-value-red" : "stat-value-green";
        tr.innerHTML = `<td class="mono" style="font-weight:500;font-size:13px;padding:10px 0;">${a}</td><td class="right mono ${cls}" style="font-weight:600;font-size:13px;padding:10px 0;">${(weight * 100).toFixed(2)}%</td>`;
        body.appendChild(tr);
      });
      const flags = el("allocationFlags");
      if(flags){
        flags.innerHTML = `<span style="color:var(--trading-green);font-weight:600;">${reco && reco.leverage ? "Leverage ON" : "Leverage OFF"}</span><span class="muted"> · risky gross: <span class="mono">${reco && reco.risky_gross != null ? Number(reco.risky_gross).toFixed(4) : "—"}x</span></span>`;
      }
    }

    function renderYTD(pctObj){
      if(!pctObj) return;
      setText("ytdStrategyMain", fmtPct(pctObj.Strategy_Net));
      setText("ytdSPYMain", fmtPct(pctObj.BuyHold_SPY));
      setText("ytd13Main", fmtPct(pctObj.BuyHold_SPY_1.3x_Net));
      setText("ytd20Main", fmtPct(pctObj.BuyHold_SPY_2.0x_Net));
      const setClass = (id, val) => {
        const e = el(id);
        if(!e) return;
        const n = Number(val);
        e.className = "mono stat-value " + (n >= 0 ? "stat-value-green" : "stat-value-red");
      };
      setClass("ytdSPYMain", pctObj.BuyHold_SPY);
      setClass("ytd13Main", pctObj.BuyHold_SPY_1.3x_Net);
      setClass("ytd20Main", pctObj.BuyHold_SPY_2.0x_Net);
    }

    function renderGrowth(ytdObj, firstDateStr){
      const c = el("growthTracker");
      if(!c) return;
      if(!ytdObj){
        c.innerHTML = '<p style="font-size:13px;color:var(--muted);">No YTD data.</p>';
        return;
      }
      const items = [
        { label: "Strategy", ytd: ytdObj.Strategy_Net },
        { label: "SPY B&H", ytd: ytdObj.BuyHold_SPY },
        { label: "SPY 1.3x", ytd: ytdObj.BuyHold_SPY_1.3x_Net },
        { label: "SPY 2.0x", ytd: ytdObj.BuyHold_SPY_2.0x_Net }
      ];
      c.innerHTML = items.map((item) => {
        const endVal = 1000 * (1 + item.ytd);
        const diff = endVal - 1000;
        const valColor = item.label === "Strategy" ? "var(--trading-green)" : (diff >= 0 ? "var(--text)" : "var(--trading-red)");
        const diffColor = diff >= 0 ? "var(--trading-green)" : "var(--trading-red)";
        return `<div style="text-align:center;"><p style="font-size:10px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin:0 0 8px;">${item.label}</p><p style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:${valColor};margin:0 0 4px;">${fmtCurrency(endVal)}</p><p style="font-size:11px;font-family:'JetBrains Mono',monospace;color:${diffColor};margin:0;">${diff >= 0 ? "+" : ""}${fmtCurrency(diff)}</p></div>`;
      }).join("");
      if(firstDateStr){
        const d = el("growthTrackerDesc");
        if(d) d.textContent = `If you invested $1,000 on ${firstDateStr} — here's where you'd be today.`;
      }
    }

    function renderChart(rows, ytdYear){
      const canvas = el("ytdChart");
      const placeholder = el("ytdChartPlaceholder");
      if(!canvas || !canvas.parentNode) return;
      const ytdRows = rows.filter(r => r.date && String(r.date).startsWith(String(ytdYear)));
      if(ytdRows.length === 0){
        if(placeholder) placeholder.textContent = `No YTD data for ${ytdYear}.`;
        return;
      }
      if(typeof Chart === "undefined"){
        if(placeholder) placeholder.textContent = "Chart unavailable right now.";
        return;
      }

      if(placeholder) placeholder.style.display = "none";
      const s0 = ytdRows[0];
      const strat0 = Number(s0.Strategy_Net_Eq) || 1;
      const spy0 = Number(s0.BuyHold_SPY_Eq) || 1;
      const s13_0 = Number(s0["BuyHold_SPY_1.3x_Net_Eq"]) || 1;
      const s20_0 = Number(s0["BuyHold_SPY_2.0x_Net_Eq"]) || 1;
      const labels = ytdRows.map(r => new Date(r.date).toLocaleDateString("en-US", {month: "short", day: "numeric"}));
      const strat = ytdRows.map(r => ((Number(r.Strategy_Net_Eq) || strat0) / strat0 - 1) * 100);
      const spy = ytdRows.map(r => ((Number(r.BuyHold_SPY_Eq) || spy0) / spy0 - 1) * 100);
      const spy13 = ytdRows.map(r => ((Number(r["BuyHold_SPY_1.3x_Net_Eq"]) || s13_0) / s13_0 - 1) * 100);
      const spy20 = ytdRows.map(r => ((Number(r["BuyHold_SPY_2.0x_Net_Eq"]) || s20_0) / s20_0 - 1) * 100);

      new Chart(canvas.getContext("2d"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Strategy (Net)", data: strat, borderColor: "hsl(142 72% 45%)", backgroundColor: "hsla(142,72%,45%,0.08)", borderWidth: 2.5, tension: 0.4, fill: true, pointRadius: 0 },
            { label: "SPY B&H", data: spy, borderColor: "hsl(215 12% 50%)", borderWidth: 1.5, borderDash: [4, 2], tension: 0.4, pointRadius: 0 },
            { label: "SPY 1.3x", data: spy13, borderColor: "hsl(187 80% 52%)", borderWidth: 1.5, borderDash: [4, 2], tension: 0.4, pointRadius: 0 },
            { label: "SPY 2.0x", data: spy20, borderColor: "hsl(0 72% 55%)", borderWidth: 1.5, borderDash: [4, 2], tension: 0.4, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: { legend: { display: true }, tooltip: { callbacks: { label: (it) => `${it.dataset.label}: ${Number(it.raw) >= 0 ? "+" : ""}${Number(it.raw).toFixed(2)}%` } } },
          scales: {
            x: { ticks: { color: "hsl(215 12% 50%)", maxTicksLimit: 10 }, grid: { color: "hsla(220,14%,18%,0.5)" } },
            y: { ticks: { color: "hsl(215 12% 50%)", callback: (v) => `${v}%` }, grid: { color: "hsla(220,14%,18%,0.5)" } }
          }
        }
      });
    }

    async function ensureChartJs(){
      if(typeof Chart !== "undefined") return;
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Chart.js"));
        document.head.appendChild(s);
      });
    }

    async function main(){
      let latest;
      try {
        latest = await loadJSON("data/latest.json");
      } catch (err) {
        setText("portfolioDateRange", "As of: —");
        const g = el("growthTracker");
        if(g) g.innerHTML = '<p style="font-size:13px;color:var(--muted);">Could not load data. Check <span class="mono">data/latest.json</span>.</p>';
        const ph = el("ytdChartPlaceholder");
        if(ph) ph.textContent = "Chart data could not be loaded.";
        console.error("Portfolio latest.json load failed:", err);
        return;
      }

      renderAllocation(latest.recommendation || {});
      setText("portfolioDateRange", latest.last_backtest_date ? "As of: " + new Date(latest.last_backtest_date).toLocaleDateString("en-US", {year: "numeric", month: "short", day: "numeric"}) : "As of: —");

      const s = latest.summary;
      if(s){
        renderYTD({
          Strategy_Net: s.Strategy_Net && s.Strategy_Net.YTD,
          BuyHold_SPY: s.BuyHold_SPY && s.BuyHold_SPY.YTD,
          BuyHold_SPY_1.3x_Net: s["BuyHold_SPY_1.3x_Net"] && s["BuyHold_SPY_1.3x_Net"].YTD,
          BuyHold_SPY_2.0x_Net: s["BuyHold_SPY_2.0x_Net"] && s["BuyHold_SPY_2.0x_Net"].YTD
        });
        renderGrowth({
          Strategy_Net: s.Strategy_Net && s.Strategy_Net.YTD,
          BuyHold_SPY: s.BuyHold_SPY && s.BuyHold_SPY.YTD,
          BuyHold_SPY_1.3x_Net: s["BuyHold_SPY_1.3x_Net"] && s["BuyHold_SPY_1.3x_Net"].YTD,
          BuyHold_SPY_2.0x_Net: s["BuyHold_SPY_2.0x_Net"] && s["BuyHold_SPY_2.0x_Net"].YTD
        });
      }

      let csvRows = [];
      let ytdYear = null;
      try {
        const csv = await loadCSV("data/equity_curve_TURBO_phase7_BASE.csv");
        csvRows = csv.rows || [];
        if(csvRows.length > 0){
          const lastRow = csvRows.filter(r => r.date).pop();
          ytdYear = (lastRow && lastRow.date) ? parseInt(String(lastRow.date).slice(0, 4), 10) : new Date().getFullYear();
          const ytdFromEq = computeYTDFromEquity(csvRows, ytdYear);
          if(ytdFromEq){
            renderYTD(ytdFromEq);
            renderGrowth(ytdFromEq);
            const ytdRows = csvRows.filter(r => r.date && String(r.date).startsWith(String(ytdYear)));
            if(ytdRows.length > 0){
              const firstD = new Date(ytdRows[0].date).toLocaleDateString("en-US", {month: "short", day: "numeric", year: "numeric"});
              renderGrowth(ytdFromEq, firstD);
            }
          }
        }
      } catch (err) {
        const ph = el("ytdChartPlaceholder");
        if(ph) ph.textContent = "Chart data file could not be loaded.";
        console.error("Portfolio CSV load failed:", err);
      }

      if(csvRows.length > 0 && ytdYear !== null){
        try {
          await ensureChartJs();
          renderChart(csvRows, ytdYear);
        } catch (err) {
          const ph = el("ytdChartPlaceholder");
          if(ph) ph.textContent = "Chart unavailable right now.";
          console.error("Chart.js load/render failed:", err);
        }
      }
    }

    main().catch((err) => {
      console.error("Portfolio fatal error:", err);
    });
  </script>
</body>
</html>
