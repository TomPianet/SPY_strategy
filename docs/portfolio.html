<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPY Strategy — Portfolio Live 2</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">
        <div class="logo"><img src="assets/images/logo.png" alt="SPY Strategy Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;"></div>
        <div>
          <div class="brandTitle">Systematic Investment Platform</div>
          <div class="brandSub">Live Portfolio</div>
        </div>
      </div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a class="active" href="portfolio.html">Portfolio YTD</a>
        <a href="risk-management.html">Risk</a>
        <a href="results.html">Results</a>
        <a href="visuals.html">Visuals</a>
        <a href="methodology.html">Methodology</a>
      </div>
    </nav>

    <!-- Header -->
    <section style="margin-top: 24px; margin-bottom: 32px;">
      <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 12px; letter-spacing: -0.02em; font-family: 'Inter', sans-serif;">Portfolio Live 2</h1>
      <p style="font-size: 16px; color: var(--muted); margin: 0 0 16px; line-height: 1.6;">Year-to-date performance, $1,000 growth comparison, and current allocation.</p>
      <span class="pill" id="portfolioDateRange" style="font-size: 11px;">As of: —</span>
    </section>

    <!-- 1. Growth of $1,000 (top) -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">Growth of $1,000</h2>
      <div class="small" style="margin-bottom: 16px; font-size: 11px;" id="growthTrackerDesc">If you invested $1,000 at the start of YTD — here's where you'd be today.</div>
      <div id="growthTracker" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
        <p style="font-size: 13px; color: var(--muted); margin: 0;">Loading…</p>
      </div>
    </section>

    <!-- 2. YTD Chart: strategy vs benchmarks -->
    <section class="card" style="margin-bottom: 24px;">
      <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">YTD cumulative returns</h2>
      <div class="small" style="margin-bottom: 24px; font-size: 11px;">Strategy vs benchmarks — net of costs &amp; financing.</div>
      <div style="position: relative; height: 360px; width: 100%;" id="ytdChartWrap">
        <canvas id="ytdChart"></canvas>
        <div id="ytdChartPlaceholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;">Loading chart…</div>
      </div>
    </section>

    <!-- 3. YTD numbers + Allocation (two columns) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px;">
      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">YTD returns (numbers)</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Cumulative year-to-date — from your data.</div>
        <div style="display: flex; flex-direction: column; gap: 0;">
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">Strategy (Net)</span>
            <span class="stat-value stat-value-green mono" id="ytdStrategyMain" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY B&H</span>
            <span id="ytdSPYMain" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border);">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 1.3x (Net)</span>
            <span id="ytd13Main" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0;">
            <span style="font-size: 14px; font-family: 'JetBrains Mono', monospace; color: var(--muted);">SPY 2.0x (Net)</span>
            <span id="ytd20Main" class="mono" style="font-size: 18px; font-weight: 700;">—</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0 0 4px;">Current allocation</h2>
        <div class="small" style="margin-bottom: 16px; font-size: 11px;">Actual portfolio weights (next week).</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="font-size: 11px; padding: 8px 0;">Asset</th>
                <th class="right" style="font-size: 11px; padding: 8px 0;">Weight</th>
              </tr>
            </thead>
            <tbody id="allocationBody"></tbody>
          </table>
        </div>
        <div class="small" id="allocationFlags" style="margin-top: 16px; font-size: 11px;"></div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    (function(){
      var fmtPct = function(x){
        var n = Number(x);
        if (!Number.isFinite(n)) return "—";
        return (n * 100).toFixed(2) + "%";
      };
      var fmtCurrency = function(x){
        var n = Number(x);
        if (!Number.isFinite(n)) return "—";
        return "$" + n.toFixed(2);
      };
      function el(id){ return document.getElementById(id); }
      function setText(id, val){ var e = el(id); if(e) e.textContent = val; }

      function loadJSON(path){
        return fetch(path, {cache:"no-store"}).then(function(r){ if(!r.ok) throw new Error("Cannot load " + path); return r.json(); });
      }
      function loadCSV(path){
        return fetch(path, {cache:"no-store"})
          .then(function(r){ if(!r.ok) throw new Error("Cannot load " + path); return r.text(); })
          .then(function(text){
            if(text.length && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            var lines = text.trim().split(/\r?\n/).filter(function(l){ return l.trim(); });
            if(lines.length === 0) return {headers:[], rows:[]};
            var headers = lines[0].split(",").map(function(h){ return h.trim().replace(/^\uFEFF/, ""); });
            var rows = lines.slice(1).map(function(line){
              var parts = line.split(",").map(function(p){ return p.trim(); });
              var obj = {};
              headers.forEach(function(h,i){ obj[h] = parts[i] || ""; });
              return obj;
            });
            return {headers: headers, rows: rows};
          });
      }

      function computeYTDFromEquity(rows, ytdYear){
        var ytdRows = rows.filter(function(r){ return r.date && String(r.date).indexOf(String(ytdYear)) === 0; });
        if(ytdRows.length < 1) return null;
        var first = ytdRows[0], last = ytdRows[ytdRows.length - 1];
        var cols = ["Strategy_Net_Eq","BuyHold_SPY_Eq","BuyHold_SPY_1.3x_Net_Eq","BuyHold_SPY_2.0x_Net_Eq"];
        var keys = ["Strategy_Net","BuyHold_SPY","BuyHold_SPY_1.3x_Net","BuyHold_SPY_2.0x_Net"];
        var out = {};
        cols.forEach(function(col, i){
          var s = Number(first[col]) || 1, e = Number(last[col]) || 1;
          out[keys[i]] = s > 0 ? (e / s) - 1 : 0;
        });
        return out;
      }

      function renderAllocation(reco){
        var body = el("allocationBody");
        if(!body) return;
        body.innerHTML = "";
        var w = reco.weights || {SPY:0,TLT:0,GLD:0,BIL:1};
        ["SPY","TLT","GLD","BIL"].forEach(function(a){
          var weight = Number(w[a]);
          var tr = document.createElement("tr");
          var cls = weight < 0 ? "stat-value-red" : "stat-value-green";
          tr.innerHTML = "<td class=\"mono\" style=\"font-weight:500;font-size:13px;padding:10px 0;\">" + a + "</td><td class=\"right mono " + cls + "\" style=\"font-weight:600;font-size:13px;padding:10px 0;\">" + (weight * 100).toFixed(2) + "%</td>";
          body.appendChild(tr);
        });
        var flags = el("allocationFlags");
        if(flags) flags.innerHTML = "<span style=\"color:var(--trading-green);font-weight:600;\">" + (reco.leverage ? "Leverage ON" : "Leverage OFF") + "</span><span class=\"muted\"> · risky gross: <span class=\"mono\">" + (reco.risky_gross != null ? Number(reco.risky_gross).toFixed(4) : "—") + "x</span></span>";
      }

      function renderYTD(pctObj){
        if(!pctObj) return;
        setText("ytdStrategyMain", fmtPct(pctObj.Strategy_Net));
        setText("ytdSPYMain", fmtPct(pctObj.BuyHold_SPY));
        setText("ytd13Main", fmtPct(pctObj.BuyHold_SPY_1.3x_Net));
        setText("ytd20Main", fmtPct(pctObj.BuyHold_SPY_2.0x_Net));
        var setClass = function(id, val){
          var e = el(id); if(!e) return;
          var n = Number(val); e.className = "mono stat-value " + (n >= 0 ? "stat-value-green" : "stat-value-red");
        };
        setClass("ytdSPYMain", pctObj.BuyHold_SPY);
        setClass("ytd13Main", pctObj.BuyHold_SPY_1.3x_Net);
        setClass("ytd20Main", pctObj.BuyHold_SPY_2.0x_Net);
      }

      function renderGrowth(ytdObj, firstDateStr){
        var c = el("growthTracker");
        if(!c) return;
        if(!ytdObj){ c.innerHTML = "<p style=\"font-size:13px;color:var(--muted);\">No YTD data.</p>"; return; }
        var items = [
          { label: "Strategy", ytd: ytdObj.Strategy_Net },
          { label: "SPY B&H", ytd: ytdObj.BuyHold_SPY },
          { label: "SPY 1.3x", ytd: ytdObj.BuyHold_SPY_1.3x_Net },
          { label: "SPY 2.0x", ytd: ytdObj.BuyHold_SPY_2.0x_Net }
        ];
        var html = items.map(function(item){
          var endVal = 1000 * (1 + item.ytd), diff = endVal - 1000;
          var valColor = item.label === "Strategy" ? "var(--trading-green)" : (diff >= 0 ? "var(--text)" : "var(--trading-red)");
          var diffColor = diff >= 0 ? "var(--trading-green)" : "var(--trading-red)";
          return "<div style=\"text-align:center;\"><p style=\"font-size:10px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin:0 0 8px;\">" + item.label + "</p><p style=\"font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:" + valColor + ";margin:0 0 4px;\">" + fmtCurrency(endVal) + "</p><p style=\"font-size:11px;font-family:'JetBrains Mono',monospace;color:" + diffColor + ";margin:0;\">" + (diff >= 0 ? "+" : "") + fmtCurrency(diff) + "</p></div>";
        }).join("");
        c.innerHTML = html;
        if(firstDateStr){ var d = el("growthTrackerDesc"); if(d) d.textContent = "If you invested $1,000 on " + firstDateStr + " — here's where you'd be today."; }
      }

      function renderChart(rows, ytdYear){
        var canvas = el("ytdChart");
        var placeholder = el("ytdChartPlaceholder");
        if(!canvas || !canvas.parentNode) return;
        if(placeholder) placeholder.style.display = "none";
        var ytdRows = rows.filter(function(r){ return r.date && String(r.date).indexOf(String(ytdYear)) === 0; });
        if(ytdRows.length === 0){
          if(canvas.parentNode) canvas.parentNode.innerHTML = "<div style=\"padding:40px;text-align:center;color:var(--muted);\">No YTD data for " + ytdYear + ".</div>";
          return;
        }
        var s0 = ytdRows[0], strat0 = Number(s0.Strategy_Net_Eq) || 1, spy0 = Number(s0.BuyHold_SPY_Eq) || 1, s13_0 = Number(s0["BuyHold_SPY_1.3x_Net_Eq"]) || 1, s20_0 = Number(s0["BuyHold_SPY_2.0x_Net_Eq"]) || 1;
        var labels = ytdRows.map(function(r){ var d = new Date(r.date); return d.toLocaleDateString("en-US", {month:"short", day:"numeric"}); });
        var strat = ytdRows.map(function(r){ var v = Number(r.Strategy_Net_Eq) || strat0; return ((v/strat0)-1)*100; });
        var spy = ytdRows.map(function(r){ var v = Number(r.BuyHold_SPY_Eq) || spy0; return ((v/spy0)-1)*100; });
        var spy13 = ytdRows.map(function(r){ var v = Number(r["BuyHold_SPY_1.3x_Net_Eq"]) || s13_0; return ((v/s13_0)-1)*100; });
        var spy20 = ytdRows.map(function(r){ var v = Number(r["BuyHold_SPY_2.0x_Net_Eq"]) || s20_0; return ((v/s20_0)-1)*100; });
        if(typeof Chart === "undefined"){ canvas.parentNode.innerHTML = "<div style=\"padding:40px;text-align:center;color:var(--muted);\">Chart.js not loaded.</div>"; return; }
        try {
          new Chart(canvas.getContext("2d"), {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                { label: "Strategy (Net)", data: strat, borderColor: "hsl(142 72% 45%)", backgroundColor: "hsla(142,72%,45%,0.08)", borderWidth: 2.5, tension: 0.4, fill: true, pointRadius: 0 },
                { label: "SPY B&H", data: spy, borderColor: "hsl(215 12% 50%)", borderWidth: 1.5, borderDash: [4,2], tension: 0.4, pointRadius: 0 },
                { label: "SPY 1.3x", data: spy13, borderColor: "hsl(187 80% 52%)", borderWidth: 1.5, borderDash: [4,2], tension: 0.4, pointRadius: 0 },
                { label: "SPY 2.0x", data: spy20, borderColor: "hsl(0 72% 55%)", borderWidth: 1.5, borderDash: [4,2], tension: 0.4, pointRadius: 0 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              plugins: { legend: { display: true }, tooltip: { callbacks: { label: function(it){ return it.dataset.label + ": " + (Number(it.raw) >= 0 ? "+" : "") + Number(it.raw).toFixed(2) + "%"; } } } },
              scales: {
                x: { ticks: { color: "hsl(215 12% 50%)", maxTicksLimit: 10 }, grid: { color: "hsla(220,14%,18%,0.5)" } },
                y: { ticks: { color: "hsl(215 12% 50%)", callback: function(v){ return v + "%"; } }, grid: { color: "hsla(220,14%,18%,0.5)" } }
              }
            }
          });
        } catch(e) {
          canvas.parentNode.innerHTML = "<div style=\"padding:40px;text-align:center;color:var(--muted);\">Chart error: " + (e.message || "unknown") + "</div>";
        }
      }

      function run(){
        loadJSON("data/latest.json").then(function(latest){
          var rec = latest.recommendation;
          if(rec) renderAllocation(rec);
          var d = latest.last_backtest_date;
          setText("portfolioDateRange", d ? "As of: " + new Date(d).toLocaleDateString("en-US", {year:"numeric", month:"short", day:"numeric"}) : "As of: —");
          var s = latest.summary;
          if(s){
            var pct = { Strategy_Net: s.Strategy_Net && s.Strategy_Net.YTD, BuyHold_SPY: s.BuyHold_SPY && s.BuyHold_SPY.YTD, BuyHold_SPY_1.3x_Net: s["BuyHold_SPY_1.3x_Net"] && s["BuyHold_SPY_1.3x_Net"].YTD, BuyHold_SPY_2.0x_Net: s["BuyHold_SPY_2.0x_Net"] && s["BuyHold_SPY_2.0x_Net"].YTD };
            renderYTD(pct);
            renderGrowth(pct, null);
          }
          loadCSV("data/equity_curve_TURBO_phase7_BASE.csv").then(function(csv){
            var rows = csv.rows || [];
            if(rows.length === 0) return;
            var lastRow = rows.filter(function(r){ return r.date; }).pop();
            var ytdYear = lastRow && lastRow.date ? parseInt(String(lastRow.date).slice(0,4), 10) : new Date().getFullYear();
            var ytdFromEq = computeYTDFromEquity(rows, ytdYear);
            if(ytdFromEq){
              renderYTD(ytdFromEq);
              renderGrowth(ytdFromEq, null);
              var ytdRows = rows.filter(function(r){ return r.date && String(r.date).indexOf(String(ytdYear)) === 0; });
              if(ytdRows.length > 0){ var firstD = new Date(ytdRows[0].date).toLocaleDateString("en-US", {month:"short", day:"numeric", year:"numeric"}); var desc = el("growthTrackerDesc"); if(desc) desc.textContent = "If you invested $1,000 on " + firstD + " — here's where you'd be today."; }
            }
            setTimeout(function(){ renderChart(rows, ytdYear); }, 100);
          }).catch(function(){
            var ph = el("ytdChartPlaceholder");
            if(ph) ph.textContent = "Chart: equity curve file could not be loaded.";
          });
        }).catch(function(err){
          setText("portfolioDateRange", "As of: —");
          var g = el("growthTracker");
          if(g) g.innerHTML = "<p style=\"font-size:13px;color:var(--muted);\">Could not load data. Check data/latest.json.</p>";
          var ph = el("ytdChartPlaceholder");
          if(ph) ph.textContent = "Data could not be loaded.";
          console.error(err);
        });
      }
      if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
      else run();
    })();
  </script>
</body>
</html>
